import{Subject as t,BehaviorSubject as e,map as i,distinctUntilChanged as s,filter as n,pairwise as r}from"rxjs";import{v4 as h}from"uuid";var o;!function(t){t[t.change=0]="change",t[t.mount=1]="mount",t[t.unmount=2]="unmount",t[t.treeUpdate=3]="treeUpdate"}(o||(o={}));class a{constructor(i,s){this.initiator=null,this.mounted=!1,this.subscriptions=[],this.eventObserver=new t,this.parent=null,this.childKeys=new e([]),this.history={enabled:!0,__batch:!1,__ignoreNextUpdate:!1},this.userData={},Object.defineProperties(this,{initiator:{value:s||null,writable:!1,configurable:!1,enumerable:!1},id:{value:i.id||h(),writable:!1,configurable:!1},name:{value:i.name,writable:!1,configurable:!1}}),this.data=new e({attrs:i.attrs,children:[]})}__initialize(){const t=this.data.pipe(i((({children:t})=>t)),s()).subscribe((t=>{this.childKeys.next(t.map((t=>t.id)))})),e=this.eventObserver.pipe(n((({type:t})=>t===o.treeUpdate))).subscribe((t=>{this.history.enabled&&!this.history.__batch||t.tag!==this&&(t.tag.history.__ignoreNextUpdate=!0),this.parent&&this.parent.eventObserver.next(t)})),h=this.data.pipe(r()).subscribe((t=>{const e={type:o.change,prev:t[0],next:t[1]};this.eventObserver.next(e),this.eventObserver.next({type:o.treeUpdate,tag:this,event:e})}));this.addSubscription(t),this.addSubscription(e),this.addSubscription(h)}get historyBatch(){return this.history.__batch}set historyBatch(t){if(this.historyBatch!==t){if(t){const t={attrs:this.attrs,children:this.children};this.data.next(t)}if(this.history.__batch=t,!t){const t={attrs:this.attrs,children:this.children};this.data.next(t)}}}get path(){return this.isMounted?this.parent?[...this.parent.path,this.id]:[]:null}get isMounted(){return this.mounted}set isMounted(t){if(t!==this.mounted){for(const e of this.children)e.isMounted=t;if(t)this.__initialize(),this.initiator&&this.initiator(this),this.eventObserver.next({type:o.mount});else{this.eventObserver.next({type:o.unmount});for(const t of this.subscriptions)t.unsubscribe();this.subscriptions.splice(0,this.subscriptions.length),this.userData={}}this.mounted=t}}get attrs(){return this.data.value.attrs}get children(){return this.data.value.children}get rx(){return this.data}get events(){return this.eventObserver}findByPath(t){if(0===t.length)return this;const e=t[0];for(const i of this.children)if(i.id===e)return i.findByPath(t.slice(1));return null}findById(t,e=!1){let i;for(const s of this.children){if(s.id===t)return s;if(e&&(i=s.findById(t)))return i}return null}findByName(t,e=!1){let i;for(const s of this.children){if(s.name===t)return s;if(e&&(i=s.findByName(t)))return i}return null}find(t,e=!1){let i;for(const s of this.children){if(t(s))return s;if(e&&(i=s.find(t)))return i}return null}getRoot(){return this.parent?this.parent.getRoot():null}get subscriptionsSize(){return this.subscriptions.length}addSubscription(t){this.subscriptions.push(t)}removeSubscription(t){this.subscriptions=this.subscriptions.filter((e=>e!==t||(t.unsubscribe(),!1)))}onUnmount(t){return this.eventObserver.pipe(n((({type:t})=>t===o.unmount))).subscribe(t)}onChange(t){return this.eventObserver.pipe(n((({type:t})=>t===o.change))).subscribe(t)}onTreeUpdate(t){return this.eventObserver.pipe(n((({type:t})=>t===o.treeUpdate))).subscribe(t)}setAttr(t,e){const i={attrs:{...this.attrs,[t]:e},children:this.children};this.data.next(i)}setAttrs(t){const e={attrs:{...t},children:this.children};this.data.next(e)}addChild(...t){const e=[...this.children];for(const i of t)i.parent&&i.parent!==this&&i.parent.removeChild(i),i.parent&&i.parent===this||(e.push(i),i.parent=this,i.isMounted=this.isMounted);const i={attrs:this.attrs,children:e};this.data.next(i)}removeChild(t){const e=(Array.isArray(t)?t:[t]).filter((t=>t.parent&&t.parent===this)).map((t=>(t.parent=null,t.isMounted=!1,t.id)));if(!e.length)return!1;const i=this.children.filter((t=>-1===e.indexOf(t.id))),s={attrs:this.attrs,children:i};return this.data.next(s),!0}filterChild(t){const e=[],i=this.children.filter((i=>!!t(i)||(e.push(i),!1))),s={attrs:this.attrs,children:i};for(const t of e)t.parent=null,t.isMounted=!1;this.data.next(s)}remove(){return!!this.parent&&this.parent.removeChild(this)}traverse(t){for(const e of this.children)t(e),e.traverse(t)}get vdom(){return{name:this.name,id:this.id,attrs:this.attrs,children:this.children.map((t=>t.vdom))}}toJSON(){return this.vdom}}const u={current:null,get:function(){return this.current},set:function(t){this.current=t}},c={},d=()=>{for(const t in c)delete c[t]},l=t=>{const e=[];for(const i of t.children){const t=l(i);t&&e.push(t)}return t.name in c?c[t.name](t.id,t.attrs,e):null},p=(t,e)=>{if(t in c)throw new Error(`Name ${t} already registered. Name should be a uniq string`);const i=(i=null,s={},n=[])=>{const r=e&&(t=>{u.set(t),e(t),u.set(null)}),h=new a({id:i||"",name:t,attrs:s},r);return n.length&&h.addChild(...n),h};return c[t]=i,i},f=(t,e,i=!1)=>{if(t.name!==e.name)return null;t.history.__ignoreNextUpdate=i;const s=[],n=[],r=[],h=t.childKeys.value;for(const i of e.children){const e=h.indexOf(i.id);if(-1!==e){const n=f(t.children[e],i,!0);r.push(e),s.push(n)}else{const e=l(i);if(e){const r=f(e,i,!0);n.push(r),s.push(r),r.parent=t}}}for(let e=0;e<t.children.length;e++){if(-1!==r.indexOf(e))continue;const i=t.children[e];i.isMounted=!1,i.parent=null}const o={attrs:e.attrs,children:s};t.data.next(o);for(const e of n)e.isMounted=t.isMounted;return t};class b{constructor(t){this.stack=[],this.pointer=0,this.size=256,this.owner=t,this.stack.push({path:t.path,vdom:t.vdom})}push(t){t.tag.history.enabled&&!t.tag.historyBatch&&(t.tag.history.__ignoreNextUpdate?t.tag.history.__ignoreNextUpdate=!1:(this.stack.splice(this.pointer+1,this.stack.length-this.pointer),this.stack.push({path:t.tag.path,vdom:t.tag.vdom}),this.stack.length>this.size&&(this.stack=this.stack.slice(this.stack.length-this.size)),this.pointer=this.stack.length-1))}undo(){if(this.pointer<=0)return!1;const t=this.stack[--this.pointer],e=this.owner.findByPath(t.path);return e&&f(e,t.vdom,!0),!0}redo(){if(this.pointer>=this.stack.length-1)return!1;const t=this.stack[++this.pointer],e=this.owner.findByPath(t.path);return e&&f(e,t.vdom,!0),!0}clear(){this.stack.splice(0,this.stack.length),this.pointer=0}jump(t){const e=t<0?-t:t,i=t<0?this.undo.bind(this):this.redo.bind(this);for(let t=0;t<=e;t++)i()}}class g extends a{constructor(t,e){super({name:t||"Document",id:e||"root",attrs:{}}),this.__initialize(),this.historyManager=new b(this),this.eventObserver.pipe(n((({type:t})=>t===o.treeUpdate))).subscribe((t=>this.historyManager.push(t)))}get isMounted(){return!0}getRoot(){return this}}const m=t=>{const e=u.get();if(!e)throw new Error("rxMount hook is out of the component");const i=e.events.subscribe((e=>{e.type===o.change&&t(e)}));e.addSubscription(i)},v=t=>{const e=u.get();if(!e)throw new Error("rxMount hook is out of the component");const i={current:null},s=e.events.subscribe((e=>{e.type===o.mount?i.current=t():e.type===o.unmount&&i.current&&(i.current(),i.current=null)}));e.addSubscription(s)};function y(){return i((t=>t.attrs))}function x(){return i((t=>t.children))}export{g as Document,a as Tag,y as attrOp,x as childOp,d as clearRegistry,l as create,p as def,f as fromVDOM,m as rxChange,v as rxMount};
//# sourceMappingURL=index.esm.js.map
